\section{McMC Algorithm}

This section gives the full details of the algorithm used to fit the fully joint non-parametric source attribution model described in Section \ref{sec:methods}.
\begin{algorithm}%[!htp]
\begin{algorithmic} 
\bigskip{}
\State \textbf{Initialise}$\colon$ Setup output matrices and initial values
\bigskip{}

\For {$z$ in $1 \colon niter$}
\bigskip{}
\State \parbox[t]{\dimexpr\linewidth-\algorithmicindent\relax}{%
    \setlength{\hangindent}{\algorithmicindent}%
      \textbf{Step 1} $\colon$ Update source effects ($\mathbf{a}$) for each time $t$ and location $l$ (adaptive single site Normal random walk Metropolis-Hastings). }\strut 
\medskip     
\State Propose $a_{j}^*\sim\textsf{Normal}\left(a_{j},\sigma\right)$ where $\sigma$ equals $\Sigma_a$ w.p. $0.95$ and $\sigma_a$ otherwise.
\If{$z\textsf{ mod}(50) == 1$}
\State Update $\Sigma_a \colon \Sigma_a^*=\Sigma_a+\textsf{sign}\left(\textsf{current acceptance rate }a_j-0.45\right)\times\textsf{min}\left(0.01,z^{-0.5}\right)$
\EndIf
\State Rescale $a_{-j}$ such that $\sum_{j=1}^m a_{j}=1$
\State Accept proposed $a_{j}^*$ w.p. $\frac{\prod_{i=1}^{n}\left(q_{k\left(i\right)}\sum_{j=1}^{m}a_{j}^{*}p_{ij}\right)^{y_{i}}e^{-q_{k\left(i\right)}\sum_{j=1}^{m}a_{j}^{*}p_{ij}}}{\prod_{i=1}^{n}\left(q_{k\left(i\right)}\sum_{j=1}^{m}a_{j}p_{ij}\right)^{y_{i}}e^{-q_{k\left(i\right)}\sum_{j=1}^{m}a_{j}p_{ij}}}\times\frac{\prod_{j=1}^{m}a_{j}^{*^{\alpha_{a}-1}}}{\prod_{j=1}^{m}a_{j}^{\alpha_{a}-1}}$

\bigskip{}
\State \parbox[t]{\dimexpr\linewidth-\algorithmicindent\relax}{%
    \setlength{\hangindent}{\algorithmicindent}%
      \textbf{Step 2} $\colon$ Update components of the relative prevalence matrices ($r_{ij}$) for each time $t$ (adaptive single site Normal random walk Metropolis-Hastings).}\strut
\medskip 
\State Propose $r_{ij}^*\sim\textsf{Normal}\left(r_{ij},\sigma\right)$ where $\sigma$ equals $\Sigma_r$ w.p. $0.95$ and $\sigma_r$ otherwise.
\If{$z\textsf{ mod}(50) == 1$}
\State Update $\Sigma_r \colon \Sigma_r^*=\Sigma_r+\textsf{sign}\left(\textsf{current acceptance rate }r_{ij}-0.45\right)\times\textsf{min}\left(0.01,z^{-0.5}\right)$
\EndIf
\State Rescale $r_{-ij}$ such that $\sum_{i=1}^n r_{ij}=1$
\State Accept proposed $r_{ij}^*$ w.p. $\frac{\prod_{i=1}^{n}\left(q_{k\left(i\right)}\sum_{j=1}^{m}a_{j}r_{ij}^{*}\pi_j\right)^{y_{i}}e^{-q_{k\left(i\right)}\sum_{j=1}^{m}a_{j}r_{ij}^{*}\pi_j}}{\prod_{i=1}^{n}\left(q_{k\left(i\right)}\sum_{j=1}^{m}a_{j}r_{ij}\pi_j\right)^{y_{i}}e^{-q_{k\left(i\right)}\sum_{j=1}^{m}a_{j}r_{ij}\pi_j}}\times\frac{\prod_{i=1}^{n}\left(r_{ij}^{*\left(x_{ij}+\alpha_{r}-1\right)}\right)}{\prod_{i=1}^{n}\left(r_{ij}^{\left(x_{ij}+\alpha_{r}-1\right)}\right)}$

\bigskip{}
\State \parbox[t]{\dimexpr\linewidth-\algorithmicindent\relax}{%
    \setlength{\hangindent}{\algorithmicindent}%
      \textbf{Step 3} $\colon$ Update type effects ($\mathbf{q}$) using a blocked Gibbs sampler (chinese restaurant construction).}\strut
\State See Algorithm~\ref{alg:mcmc} for details.
\bigskip{}
\EndFor
\bigskip{}
\end{algorithmic}
\caption{Chinese restaurant algorithm to update the type effects.}
\label{alg:mcmc_full}
\end{algorithm}